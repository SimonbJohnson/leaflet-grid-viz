var lg={mapRegister:"",_gridRegister:"",_colors:["#edf8fb","#b2e2e2","#66c2a4","#2ca25f","#006d2c"],_selectedBar:-1,init:function(){this.mapRegister.init(),this._gridRegister.init()},colors:function(t){return"undefined"==typeof t?this._colors:(this._colors=t,this)},map:function(t){this._id=t,this._geojson="",this._center=[0,0],this._zoom=1,this._nameAttr="",this._joinAttr="",this._map="",this._info="",this._currentData=[],lg.mapRegister=this,this.geojson=function(t){return"undefined"==typeof t?this._geojson:(this._geojson=t,this)},this.center=function(t){return"undefined"==typeof t?this._center:(this._center=t,this)},this.zoom=function(t){return"undefined"==typeof t?this._zoom:(this._zoom=t,this)},this.joinAttr=function(t){return"undefined"==typeof t?this._joinAttr:(this._joinAttr=t,this)},this.nameAttr=function(t){return"undefined"==typeof t?this._nameAttr:(this._nameAttr=t,this)},this.onClick=function(t){return"undefined"==typeof t?this._onClick:(this._onClick=t,this)},this._style=function(t){return{weight:1,opacity:.8,color:"#000000",fillOpacity:0,className:"dashgeom dashgeom"+t.properties[lg.mapRegister._joinAttr]}},this._onClick=function(t){return t},this.map=function(){return this._map},this.init=function(){this._map=this._initMap(this._id,this._geojson,this._center,this._zoom,this._joinAttr)},this._initMap=function(t,e,r,i,n){function o(t,e){function r(t){var e="N/A";return s._currentData.forEach(function(r){r.key==t&&(e=r.value)}),e}e.on("mouseover",function(t,e){s._info.update(t.target.feature.properties[s._nameAttr]+" - "+r(t.target.feature.properties[s._joinAttr]))}),e.on("mouseout",function(t,e){s._info.update()}),e.on("click",function(t,e){s._onClick(t.target.feature)})}var s=this,a=L.tileLayer("https://data.hdx.rwlabs.org/mapbox-base-tiles/{z}/{x}/{y}.png",{}),c=L.map("map",{center:r,zoom:i,layers:[a]});this._info=L.control(),this._info.onAdd=function(t){return this._div=L.DomUtil.create("div","mapinfo"),this.update(),this._div},this._info.update=function(t){this._div.innerHTML=t?t:"Hover a country for details"},this._info.addTo(c);L.geoJson(e,{style:this._style,onEachFeature:o}).addTo(c);return c},this.colorMap=function(t,e){this._currentData=t;var r=d3.max(t,function(t){return isNaN(t.value)?dn=0:dn=t.value,Number(dn)});t.forEach(function(t,i){if(null==e._valueAccessor(t.value)||isNaN(e._valueAccessor(t.value))||""===e._valueAccessor(t.value))d3.selectAll(".dashgeom"+t.key).attr("fill","#cccccc").attr("fill-opacity",.8);else{var n=e._colorAccessor(t.value,i,r);d3.selectAll(".dashgeom"+t.key).attr("fill",e._colors[n]).attr("fill-opacity",.8)}})}},column:function(t){this._dataName=t,this._labelName=t,this._scale=d3.scale.linear(),this._domain="default",this._axisLabels=!0,this._colors="default",this.label=function(t){return"undefined"==typeof t?this._labelName:(this._labelName=t,this)},this.scale=function(t){return"undefined"==typeof t?this._scale:(this._scale=t,this)},this.domain=function(t){return"undefined"==typeof t?this._domain:(this._domain=t,this)},this.axisLabels=function(t){return"undefined"==typeof t?this._axisLabels:(this._axisLabels=t,this)},this.valueAccessor=function(t){return"undefined"==typeof t?this._valueAccessor:(this._valueAccessor=t,this)},this.colorAccessor=function(t){return"undefined"==typeof t?this._colorAccessor:(this._colorAccessor=t,this)},this.labelAccessor=function(t){return"undefined"==typeof t?this._labelAccessor:(this._labelAccessor=t,this)},this.colors=function(t){return"undefined"==typeof t?this._colors:(this._colors=t,this)},this._valueAccessor=function(t,e){return t},this._colorAccessor=function(t,e,r){var i=Math.floor(t/r*5);return 5==i&&(i=4),i},this._labelAccessor=function(t,e){return isNaN(t)||null==t||""===t?t:d3.format("0,000")(t)}},grid:function(t){this._id=t,this._width=1e3,this._height=500,this._data=[],this._nameAttr="",this._joinAttr="",this._columns=[],this._properties={},this._vWhiteSpace=1,this._hWhiteSpace=1,this._properties.margin={top:120,right:50,bottom:20,left:120},lg._gridRegister=this,this.width=function(t){return"undefined"==typeof t?this._width:(this._width=t,this)},this.height=function(t){return"undefined"==typeof t?this._height:(this._height=t,this)},this.data=function(t){return"undefined"==typeof t?this._data:(this._data=t,this)},this.margins=function(t){return"undefined"==typeof t?this._properties.margin:(this._properties.margin=t,this)},this.nameAttr=function(t){return"undefined"==typeof t?this._nameAttr:(this._nameAttr=t,this)},this.joinAttr=function(t){return"undefined"==typeof t?this._joinAttr:(this._joinAttr=t,this)},this.columns=function(t){return"undefined"==typeof t?this._columns:(this._columns=t,this)},this.vWhiteSpace=function(t){return"undefined"==typeof t?this._vWhiteSpace:(this._vWhiteSpace=t,this)},this.hWhiteSpace=function(t){return"undefined"==typeof t?this._hWhiteSpace:(this._hWhiteSpace=t,this)},this.init=function(){this.render()},this._initColumns=function(t){var e=this,r=[];return t.forEach(function(t){if("string"==typeof t){var i=new lg.column(t);i.domain([0,d3.max(e._data,function(t){return Number(t[i._dataName])})]),i._colors=lg._colors,r.push(i)}else"default"==t._domain&&t.domain([0,d3.max(e._data,function(e){return Number(e[t._dataName])})]),"default"==t._colors&&(t._colors=lg._colors),r.push(t)}),r},this.render=function(){this._render(this._id,this._data,this._nameAttr,this._joinAttr,this._initColumns(this._columns),this._width,this._height)},this._render=function(t,e,r,i,n,o,s){var a=this;this._properties.width=this._width-this._properties.margin.left-this._properties.margin.right,this._properties.height=this._height-this._properties.margin.top-this._properties.margin.bottom,this._properties.boxWidth=this._properties.width/n.length-this._hWhiteSpace,this._properties.boxHeight=this._properties.height/e.length-this._vWhiteSpace,this._properties.x=[],n.forEach(function(t,e){a._properties.x[e]=t._scale.range([0,a._properties.boxWidth]).domain(t._domain)});var c=d3.select(t).append("svg").attr("class","dashgrid").attr("width",o).attr("height",s).append("g").attr("transform","translate("+this._properties.margin.left+","+this._properties.margin.top+")"),l=d3.tip().attr("class","d3-tip").html(function(t,e){return"Click to sort"}),h=[];n.forEach(function(t,i){h[i]=d3.tip().attr("class","d3-tip").html(function(e,r){return t._labelAccessor(e.value)});var o=c.append("g").attr("class","bars");e.sort(function(t,e){return t[a._nameAttr].localeCompare(e[a._nameAttr])});var s=[];e.forEach(function(e,r){var i={};i.pos=e.pos,i.join=e[a._joinAttr],i.value=e[t._dataName],s.push(i)});var u=d3.max(s,function(e){return Number(t._valueAccessor(e.value))});o.selectAll("rect").data(s).enter().append("rect").attr("class","bars"+i).attr("x",function(t,e){return a._properties.boxWidth*i+i*a._hWhiteSpace}).attr("y",function(t,e){return a._properties.boxHeight*e+e*a._vWhiteSpace}).attr("width",function(e){return null==t._valueAccessor(e.value)||isNaN(t._valueAccessor(e.value))||""===t._valueAccessor(e.value)?a._properties.boxWidth:a._properties.x[i](t._valueAccessor(e.value))}).attr("height",a._properties.boxHeight).attr("fill",function(e,r){if(null==t._valueAccessor(e.value)||isNaN(t._valueAccessor(e.value))||""===t._valueAccessor(e.value))return"#cccccc";var i=t._colorAccessor(e.value,r,u);return t._colors[i]});var p=a._properties.boxWidth*i+i*a._hWhiteSpace,o=c.append("g"),d=o.append("text").text(t._labelName).attr("x",0).attr("y",0).style("text-anchor","front").attr("transform","translate("+(p+a._properties.boxWidth/2-10)+",-10) rotate(-65)").attr("class",function(t){return"sortLabel sortLabel"+i}).on("click",function(){a._update(e,n,t,r)});d.on("mouseover",function(e,r){-1==lg._selectedBar&&(d3.selectAll(".maxLabel").attr("opacity",0),d3.selectAll(".sortLabel").style("font-weight","normal"),d3.selectAll(".maxLabel"+i).attr("opacity",1),d3.selectAll(".sortLabel"+i).style("font-weight","bold"),lg.mapRegister.colorMap(f,t))}),d3.selectAll(".sortLabel").call(l),t._axisLabels&&(o.append("text").text(t._labelAccessor(t._domain[t._domain.length-1])).attr("x",a._properties.boxWidth-5).attr("y",a._properties.height+a._vWhiteSpace).style("text-anchor","front").attr("transform","translate("+p+",0)").attr("opacity",0).attr("class",function(t){return"maxLabel maxLabel"+i}),o.append("text").text(t._labelAccessor(t._domain[0])).attr("x",-5).attr("y",a._properties.height+a._vWhiteSpace).style("text-anchor","front").attr("transform","translate("+p+",0)").attr("opacity",0).attr("class",function(t){return"maxLabel maxLabel"+i})),o.append("line").attr("x1",a._properties.boxWidth*(i+1)+i*a._hWhiteSpace).attr("y1",-a._hWhiteSpace/2).attr("x2",a._properties.boxWidth*(i+1)+i*a._hWhiteSpace).attr("y2",a._properties.height-a._vWhiteSpace/2).attr("opacity",0).attr("class",function(t){return"maxLabel maxLabel"+i}).attr("stroke-width",1).attr("stroke","#ddd"),o.append("line").attr("x1",a._properties.boxWidth*i+i*a._hWhiteSpace).attr("y1",-a._hWhiteSpace/2).attr("x2",a._properties.boxWidth*i+i*a._hWhiteSpace).attr("y2",a._properties.height-a._vWhiteSpace/2).attr("opacity",0).attr("class",function(t){return"maxLabel maxLabel"+i}).attr("stroke-width",1).attr("stroke","#ddd");var o=c.append("g"),_=o.selectAll("rect").data(s).enter().append("rect").attr("class","selectbars"+i).attr("x",function(t,e){return a._properties.boxWidth*i+i*a._hWhiteSpace}).attr("y",function(t,e){return a._properties.boxHeight*e+e*a._vWhiteSpace}).attr("width",function(t){return a._properties.boxWidth+a._hWhiteSpace}).attr("height",a._properties.boxHeight+a._vWhiteSpace).attr("opacity",0);d3.selectAll(".selectbars"+i).call(h[i]);var f=[];s.forEach(function(t){f.push({key:t.join,value:t.value})}),_.on("mouseover",function(e,r){d3.selectAll(".dashgeom"+e.join).attr("stroke-width",3),d3.selectAll(".horLine"+r).attr("opacity",1),-1==lg._selectedBar&&(d3.selectAll(".maxLabel").attr("opacity",0),d3.selectAll(".sortLabel").style("font-weight","normal"),d3.selectAll(".maxLabel"+i).attr("opacity",1),d3.selectAll(".sortLabel"+i).style("font-weight","bold"),lg.mapRegister.colorMap(f,t))}).on("mouseout",function(t,e){d3.selectAll(".horLine"+e).attr("opacity",0),d3.selectAll(".dashgeom"+t.join).attr("stroke-width",1)}).on("click",function(e,r){lg._selectedBar==i?lg._selectedBar=-1:(d3.selectAll(".maxLabel"+lg._selectedBar).attr("opacity",0),d3.selectAll(".sortLabel"+lg._selectedBar).style("font-weight","normal"),lg._selectedBar=i,d3.selectAll(".maxLabel"+lg._selectedBar).attr("opacity",1),d3.selectAll(".sortLabel"+lg._selectedBar).style("font-weight","bold"),lg.mapRegister.colorMap(f,t))}),d3.selectAll(".selectbars"+i).on("mouseover.something",h[i].show).on("mouseout.something",h[i].hide),d3.selectAll(".sortLabel").on("mouseover.something",l.show).on("mouseout.something",l.hide)});var u=c.append("g");u.selectAll("line").data(e).enter().append("line").attr("x1",-a._properties.margin.left).attr("y1",function(t,e){return a._properties.boxHeight*e+(e-.5)*a._vWhiteSpace}).attr("x2",a._properties.width-a._hWhiteSpace).attr("y2",function(t,e){return a._properties.boxHeight*e+(e-.5)*a._vWhiteSpace}).attr("opacity",0).attr("class",function(t,e){return"horLine"+e+" horLineTop"}).attr("stroke-width",1).attr("stroke","#ddd");var u=c.append("g");u.selectAll("line").data(e).enter().append("line").attr("x1",-a._properties.margin.left).attr("y1",function(t,e){return a._properties.boxHeight*(e+1)+(e+.5)*a._vWhiteSpace}).attr("x2",a._properties.width-a._hWhiteSpace).attr("y2",function(t,e){return a._properties.boxHeight*(e+1)+(e+.5)*a._vWhiteSpace}).attr("opacity",0).attr("class",function(t,e){return"horLine"+e+" horLineBot"}).attr("stroke-width",1).attr("stroke","#ddd"),c.append("g").selectAll("text").data(e).enter().append("text").text(function(t){return t[r]}).attr("x",function(t){return 5-a._properties.margin.left}).attr("y",function(t,e){return a._properties.boxHeight*(e+.5)+e*a._vWhiteSpace}).attr("class","nameLabels")},this._update=function(t,e,r,i){var n=this;t.sort(function(t,e){return null==r._valueAccessor(t[r._dataName])||isNaN(r._valueAccessor(t[r._dataName]))||""===r._valueAccessor(t[r._dataName])?1:null==r._valueAccessor(e[r._dataName])||isNaN(r._valueAccessor(e[r._dataName]))||""===r._valueAccessor(e[r._dataName])?-1:parseFloat(r._valueAccessor(e[r._dataName]))-parseFloat(r._valueAccessor(t[r._dataName]))}),t.forEach(function(t,e){t.pos=e}),t.sort(function(t,e){return t[n._nameAttr].localeCompare(e[n._nameAttr])}),e.forEach(function(e,r){var i=[];t.forEach(function(t,r){var o={};o.pos=t.pos,o.join=t[n._joinAttr],o.value=t[e._dataName],i.push(o)}),d3.selectAll(".bars"+r).data(i).transition().duration(750).attr("x",function(t,e){return n._properties.boxWidth*r+r*n._hWhiteSpace}).attr("y",function(t,e){return n._properties.boxHeight*t.pos+t.pos*n._vWhiteSpace}),d3.selectAll(".selectbars"+r).data(i).transition().duration(750).attr("x",function(t,e){return n._properties.boxWidth*r+r*n._hWhiteSpace}).attr("y",function(t,e){return n._properties.boxHeight*t.pos+t.pos*n._vWhiteSpace})}),d3.selectAll(".horLineTop").attr("y1",function(t,e){return n._properties.boxHeight*t.pos+(t.pos-.5)*n._vWhiteSpace}).attr("y2",function(t,e){return n._properties.boxHeight*t.pos+(t.pos-.5)*n._vWhiteSpace}),d3.selectAll(".horLineBot").attr("y1",function(t,e){return n._properties.boxHeight*(t.pos+1)+(t.pos+.5)*n._vWhiteSpace}).attr("y2",function(t,e){return n._properties.boxHeight*(t.pos+1)+(t.pos+.5)*n._vWhiteSpace}),d3.selectAll(".nameLabels").transition().duration(750).attr("y",function(t){return n._properties.boxHeight*(t.pos+.5)+t.pos*n._vWhiteSpace})}}};d3.tip=function(){function t(t){v=d(t),x=v.createSVGPoint(),document.body.appendChild(y)}function e(){return"n"}function r(){return[0,0]}function i(){return" "}function n(){var t=_();return{top:t.n.y-y.offsetHeight,left:t.n.x-y.offsetWidth/2}}function o(){var t=_();return{top:t.s.y,left:t.s.x-y.offsetWidth/2}}function s(){var t=_();return{top:t.e.y-y.offsetHeight/2,left:t.e.x}}function a(){var t=_();return{top:t.w.y-y.offsetHeight/2,left:t.w.x-y.offsetWidth}}function c(){var t=_();return{top:t.nw.y-y.offsetHeight,left:t.nw.x-y.offsetWidth}}function l(){var t=_();return{top:t.ne.y-y.offsetHeight,left:t.ne.x}}function h(){var t=_();return{top:t.sw.y,left:t.sw.x-y.offsetWidth}}function u(){var t=_();return{top:t.se.y,left:t.e.x}}function p(){var t=document.createElement("div");return t.style.position="absolute",t.style.display="none",t.style.boxSizing="border-box",t}function d(t){return t=t.node(),"svg"==t.tagName.toLowerCase()?t:t.ownerSVGElement}function _(){var t=d3.event.target,e={},r=t.getScreenCTM(),i=t.getBBox(),n=i.width,o=i.height,s=i.x,a=i.y,c=document.body.scrollTop,l=document.body.scrollLeft;return document.documentElement&&document.documentElement.scrollTop&&(c=document.documentElement.scrollTop,l=document.documentElement.scrollLeft),x.x=s+l,x.y=a+c,e.nw=x.matrixTransform(r),x.x+=n,e.ne=x.matrixTransform(r),x.y+=o,e.se=x.matrixTransform(r),x.x-=n,e.sw=x.matrixTransform(r),x.y-=o/2,e.w=x.matrixTransform(r),x.x+=n,e.e=x.matrixTransform(r),x.x-=n/2,x.y-=o/2,e.n=x.matrixTransform(r),x.y+=o,e.s=x.matrixTransform(r),e}var f=e,m=r,g=i,y=p(),v=null,x=null;t.show=function(){var e,r=g.apply(this,arguments),i=m.apply(this,arguments),n=f.apply(this,arguments),o=d3.select(y),s=0;for(o.html(r).style("display","block");s--;)o.classed(A[s],!1);return e=b.get(n).apply(this),o.classed(n,!0).style({top:e.top+i[0]+"px",left:e.left+i[1]+"px"}),t},t.hide=function(){return y.style.display="none",y.innerHTML="",t},t.attr=function(e,r){return arguments.length<2?d3.select(y).attr(e):(d3.select(y).attr(e,r),t)},t.style=function(e,r){return arguments.length<2?d3.select(y).style(e):(d3.select(y).style(e,r),t)},t.direction=function(e){return arguments.length?(f=null==e?e:d3.functor(e),t):f},t.offset=function(e){return arguments.length?(m=null==e?e:d3.functor(e),t):m},t.html=function(e){return arguments.length?(g=null==e?e:d3.functor(e),t):g};var b=d3.map({n:n,s:o,e:s,w:a,nw:c,ne:l,sw:h,se:u}),A=b.keys();return t};