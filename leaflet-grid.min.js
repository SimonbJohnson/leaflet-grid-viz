var lg={mapRegister:"",_gridRegister:"",_colors:["#edf8fb","#b2e2e2","#66c2a4","#2ca25f","#006d2c"],_selectedBar:-1,init:function(){this.mapRegister.init(),this._gridRegister.init()},update:function(){console.log("update")},colors:function(t){return"undefined"==typeof t?this._colors:(this._colors=t,this)},map:function(t){this._id=t,this._geojson="",this._center=[0,0],this._zoom=1,this._joinAttr="",this._map="",lg.mapRegister=this,this.geojson=function(t){return"undefined"==typeof t?this._geojson:(this._geojson=t,this)},this.center=function(t){return"undefined"==typeof t?this._center:(this._center=t,this)},this.zoom=function(t){return"undefined"==typeof t?this._zoom:(this._zoom=t,this)},this.joinAttr=function(t){return"undefined"==typeof t?this._joinAttr:(this._joinAttr=t,this)},this._style=function(t){return{weight:1,opacity:.8,color:"#000000",fillOpacity:0,className:"dashgeom dashgeom"+t.properties[lg.mapRegister._joinAttr]}},this.map=function(){return this._map},this.init=function(){this._map=this._initMap(this._id,this._geojson,this._center,this._zoom,this._joinAttr)},this._initMap=function(t,e,r,i){{var n=L.tileLayer("https://data.hdx.rwlabs.org/mapbox-base-tiles/{z}/{x}/{y}.png",{}),a=L.map("map",{center:r,zoom:i,layers:[n]});L.geoJson(e,{style:this._style}).addTo(a)}return a},this.colorMap=function(t){t.sort(function(t,e){return null==t.value||isNaN(t.value)||""===t.value?-1:null==e.value||isNaN(e.value)||""===e.value?1:parseFloat(t.value)-parseFloat(e.value)}),t.forEach(function(e,r){if(null==e.value||isNaN(e.value)||""===e.value)d3.selectAll(".dashgeom"+e.key).attr("fill","#cccccc").attr("fill-opacity",.8);else{var i=Math.floor(r/t.length*5);d3.selectAll(".dashgeom"+e.key).attr("fill",lg._colors[i]).attr("fill-opacity",.8)}})}},column:function(t){this._dataName=t,this._labelName=t,this._scale=d3.scale.linear(),this._domain="default",this._axisLabels=!0,this.label=function(t){return"undefined"==typeof t?this._labelName:(this._labelName=t,this)},this.domain=function(t){return"undefined"==typeof t?this._domain:(this._domain=t,this)},this.axisLabels=function(t){return"undefined"==typeof t?this._axisLabels:(this._axisLabels=t,this)}},grid:function(t){this._id=t,this._width=1e3,this._height=500,this._data=[],this._nameAttr="",this._joinAttr="",this._columns=[],this._properties={},this._vWhiteSpace=1,this._hWhiteSpace=1,this._properties.margin={top:120,right:50,bottom:20,left:120},lg._gridRegister=this,this.width=function(t){return"undefined"==typeof t?this._width:(this._width=t,this)},this.height=function(t){return"undefined"==typeof t?this._height:(this._height=t,this)},this.data=function(t){return"undefined"==typeof t?this._data:(this._data=t,this)},this.margins=function(t){return"undefined"==typeof t?this._properties.margin:(this._properties.margin=t,this)},this.nameAttr=function(t){return"undefined"==typeof t?this._nameAttr:(this._nameAttr=t,this)},this.joinAttr=function(t){return"undefined"==typeof t?this._joinAttr:(this._joinAttr=t,this)},this.columns=function(t){return"undefined"==typeof t?this._columns:(this._columns=t,this)},this.vWhiteSpace=function(t){return"undefined"==typeof t?this._vWhiteSpace:(this._vWhiteSpace=t,this)},this.hWhiteSpace=function(t){return"undefined"==typeof t?this._hWhiteSpace:(this._hWhiteSpace=t,this)},this.init=function(){this.render()},this._initColumns=function(t){var e=this,r=[];return t.forEach(function(t){if("string"==typeof t){var i=new lg.column(t);i.domain([0,d3.max(e._data,function(t){return Number(t[i._dataName])})]),r.push(i)}else"default"==t._domain&&t.domain([0,d3.max(e._data,function(e){return Number(e[t._dataName])})]),r.push(t)}),r},this.render=function(){this._render(this._id,this._data,this._nameAttr,this._joinAttr,this._initColumns(this._columns),this._width,this._height)},this._render=function(t,e,r,i,n,a,o){var s=this;this._properties.width=this._width-this._properties.margin.left-this._properties.margin.right,this._properties.height=this._height-this._properties.margin.top-this._properties.margin.bottom,this._properties.boxWidth=this._properties.width/n.length-this._hWhiteSpace,this._properties.boxHeight=this._properties.height/e.length-this._vWhiteSpace,this._properties.x=[],n.forEach(function(t,e){s._properties.x[e]=t._scale.range([0,s._properties.boxWidth]).domain(t._domain)});var h=d3.select(t).append("svg").attr("class","dashgrid").attr("width",a).attr("height",o).append("g").attr("transform","translate("+this._properties.margin.left+","+this._properties.margin.top+")"),l=d3.tip().attr("class","d3-tip").html(function(t){return isNaN(t.value)||null==t.value||""===t.value?t.value:d3.format("0,000")(t.value)}),p=d3.tip().attr("class","d3-tip").html(function(){return"Click to sort"});n.forEach(function(t,i){var a=h.append("g").attr("class","bars");e.sort(function(e,r){return null==e[t._dataName]||isNaN(e[t._dataName])||""===e[t._dataName]?-1:null==r[t._dataName]||isNaN(r[t._dataName])||""===r[t._dataName]?1:parseFloat(e[t._dataName])-parseFloat(r[t._dataName])}),e.forEach(function(t,e){t.pos=e}),e.sort(function(t,e){return t[s._nameAttr].localeCompare(e[s._nameAttr])});var o=[];e.forEach(function(e){var r={};r.pos=e.pos,r.join=e[s._joinAttr],r.value=e[t._dataName],o.push(r)}),a.selectAll("rect").data(o).enter().append("rect").attr("class","bars"+i).attr("x",function(){return s._properties.boxWidth*i+i*s._hWhiteSpace}).attr("y",function(t,e){return s._properties.boxHeight*e+e*s._vWhiteSpace}).attr("width",function(t){return null==t.value||isNaN(t.value)||""===t.value?s._properties.boxWidth:s._properties.x[i](t.value)}).attr("height",s._properties.boxHeight).attr("fill",function(t){if(null==t.value||isNaN(t.value)||""===t.value)return"#cccccc";var r=Math.floor(t.pos/e.length*5);return lg._colors[r]});var c=s._properties.boxWidth*i+i*s._hWhiteSpace,a=h.append("g");a.append("text").text(t._labelName).attr("x",0).attr("y",0).style("text-anchor","front").attr("transform","translate("+(c+s._properties.boxWidth/2-10)+",-10) rotate(-65)").attr("class","sortLabel").on("click",function(){s._update(e,n,t._dataName,r)}),d3.selectAll(".sortLabel").call(p),t._axisLabels&&(a.append("text").text(d3.format(".4s")(t._domain[t._domain.length-1])).attr("x",s._properties.boxWidth-5).attr("y",s._properties.height+s._vWhiteSpace).style("text-anchor","front").attr("transform","translate("+c+",0)").attr("opacity",0).attr("class",function(){return"maxLabel"+i}),a.append("text").text(d3.format(".4s")(t._domain[0])).attr("x",-5).attr("y",s._properties.height+s._vWhiteSpace).style("text-anchor","front").attr("transform","translate("+c+",0)").attr("opacity",0).attr("class",function(){return"maxLabel"+i})),a.append("line").attr("x1",s._properties.boxWidth*(i+1)+i*s._hWhiteSpace).attr("y1",-s._hWhiteSpace/2).attr("x2",s._properties.boxWidth*(i+1)+i*s._hWhiteSpace).attr("y2",s._properties.height-s._vWhiteSpace/2).attr("opacity",0).attr("class",function(){return"maxLabel"+i}).attr("stroke-width",1).attr("stroke","#ddd"),a.append("line").attr("x1",s._properties.boxWidth*i+i*s._hWhiteSpace).attr("y1",-s._hWhiteSpace/2).attr("x2",s._properties.boxWidth*i+i*s._hWhiteSpace).attr("y2",s._properties.height-s._vWhiteSpace/2).attr("opacity",0).attr("class",function(){return"maxLabel"+i}).attr("stroke-width",1).attr("stroke","#ddd");var a=h.append("g"),u=a.selectAll("rect").data(o).enter().append("rect").attr("class","selectbars"+i).attr("x",function(){return s._properties.boxWidth*i+i*s._hWhiteSpace}).attr("y",function(t,e){return s._properties.boxHeight*e+e*s._vWhiteSpace}).attr("width",function(){return s._properties.boxWidth+s._hWhiteSpace}).attr("height",s._properties.boxHeight+s._vWhiteSpace).attr("opacity",0);d3.selectAll(".selectbars"+i).call(l),u.on("mouseover",function(t,e){var r=[];o.forEach(function(t){r.push({key:t.join,value:t.value})}),d3.selectAll(".dashgeom"+t.join).attr("stroke-width",3),d3.selectAll(".horLine"+e).attr("opacity",1),-1==lg._selectedBar&&(d3.selectAll(".maxLabel"+i).attr("opacity",1),lg.mapRegister.colorMap(r))}).on("mouseout",function(t,e){d3.selectAll(".horLine"+e).attr("opacity",0),d3.selectAll(".dashgeom"+t.join).attr("stroke-width",1),-1==lg._selectedBar&&d3.selectAll(".maxLabel"+i).attr("opacity",0)}).on("click",function(){lg._selectedBar==i?lg._selectedBar=-1:(d3.selectAll(".maxLabel"+lg._selectedBar).attr("opacity",0),lg._selectedBar=i,d3.selectAll(".maxLabel"+lg._selectedBar).attr("opacity",1))}),d3.selectAll(".selectbars"+i).on("mouseover.something",l.show).on("mouseout.something",l.hide),d3.selectAll(".sortLabel").on("mouseover.something",p.show).on("mouseout.something",p.hide)});var c=h.append("g");c.selectAll("line").data(e).enter().append("line").attr("x1",-s._properties.margin.left).attr("y1",function(t,e){return s._properties.boxHeight*e+(e-.5)*s._vWhiteSpace}).attr("x2",s._properties.width-s._hWhiteSpace).attr("y2",function(t,e){return s._properties.boxHeight*e+(e-.5)*s._vWhiteSpace}).attr("opacity",0).attr("class",function(t,e){return"horLine"+e+" horLineTop"}).attr("stroke-width",1).attr("stroke","#ddd");var c=h.append("g");c.selectAll("line").data(e).enter().append("line").attr("x1",-s._properties.margin.left).attr("y1",function(t,e){return s._properties.boxHeight*(e+1)+(e+.5)*s._vWhiteSpace}).attr("x2",s._properties.width-s._hWhiteSpace).attr("y2",function(t,e){return s._properties.boxHeight*(e+1)+(e+.5)*s._vWhiteSpace}).attr("opacity",0).attr("class",function(t,e){return"horLine"+e+" horLineBot"}).attr("stroke-width",1).attr("stroke","#ddd"),h.append("g").selectAll("text").data(e).enter().append("text").text(function(t){return t[r]}).attr("x",function(){return 5-s._properties.margin.left}).attr("y",function(t,e){return s._properties.boxHeight*(e+.5)+e*s._vWhiteSpace}).attr("class","nameLabels")},this._update=function(t,e,r){var i=this;t.sort(function(t,e){return null==t[r]||isNaN(t[r])||""===t[r]?1:null==e[r]||isNaN(e[r])||""===e[r]?-1:parseFloat(e[r])-parseFloat(t[r])}),t.forEach(function(t,e){t.pos=e}),t.sort(function(t,e){return t[i._nameAttr].localeCompare(e[i._nameAttr])}),e.forEach(function(e,r){var n=[];t.forEach(function(t){var r={};r.pos=t.pos,r.join=t[i._joinAttr],r.value=t[e._dataName],n.push(r)}),d3.selectAll(".bars"+r).data(n).transition().duration(750).attr("x",function(){return i._properties.boxWidth*r+r*i._hWhiteSpace}).attr("y",function(t){return i._properties.boxHeight*t.pos+t.pos*i._vWhiteSpace}),d3.selectAll(".selectbars"+r).data(n).transition().duration(750).attr("x",function(){return i._properties.boxWidth*r+r*i._hWhiteSpace}).attr("y",function(t){return i._properties.boxHeight*t.pos+t.pos*i._vWhiteSpace})}),d3.selectAll(".horLineTop").attr("y1",function(t){return i._properties.boxHeight*t.pos+(t.pos-.5)*i._vWhiteSpace}).attr("y2",function(t){return i._properties.boxHeight*t.pos+(t.pos-.5)*i._vWhiteSpace}),d3.selectAll(".horLineBot").attr("y1",function(t){return i._properties.boxHeight*(t.pos+1)+(t.pos+.5)*i._vWhiteSpace}).attr("y2",function(t){return i._properties.boxHeight*(t.pos+1)+(t.pos+.5)*i._vWhiteSpace}),d3.selectAll(".nameLabels").transition().duration(750).attr("y",function(t){return i._properties.boxHeight*(t.pos+.5)+t.pos*i._vWhiteSpace})}}};d3.tip=function(){function t(t){y=d(t),v=y.createSVGPoint(),document.body.appendChild(x)}function e(){return"n"}function r(){return[0,0]}function i(){return" "}function n(){var t=f();return{top:t.n.y-x.offsetHeight,left:t.n.x-x.offsetWidth/2}}function a(){var t=f();return{top:t.s.y,left:t.s.x-x.offsetWidth/2}}function o(){var t=f();return{top:t.e.y-x.offsetHeight/2,left:t.e.x}}function s(){var t=f();return{top:t.w.y-x.offsetHeight/2,left:t.w.x-x.offsetWidth}}function h(){var t=f();return{top:t.nw.y-x.offsetHeight,left:t.nw.x-x.offsetWidth}}function l(){var t=f();return{top:t.ne.y-x.offsetHeight,left:t.ne.x}}function p(){var t=f();return{top:t.sw.y,left:t.sw.x-x.offsetWidth}}function c(){var t=f();return{top:t.se.y,left:t.e.x}}function u(){var t=document.createElement("div");return t.style.position="absolute",t.style.display="none",t.style.boxSizing="border-box",t}function d(t){return t=t.node(),"svg"==t.tagName.toLowerCase()?t:t.ownerSVGElement}function f(){var t=d3.event.target,e={},r=t.getScreenCTM(),i=t.getBBox(),n=i.width,a=i.height,o=i.x,s=i.y,h=document.body.scrollTop,l=document.body.scrollLeft;return document.documentElement&&document.documentElement.scrollTop&&(h=document.documentElement.scrollTop,l=document.documentElement.scrollLeft),v.x=o+l,v.y=s+h,e.nw=v.matrixTransform(r),v.x+=n,e.ne=v.matrixTransform(r),v.y+=a,e.se=v.matrixTransform(r),v.x-=n,e.sw=v.matrixTransform(r),v.y-=a/2,e.w=v.matrixTransform(r),v.x+=n,e.e=v.matrixTransform(r),v.x-=n/2,v.y-=a/2,e.n=v.matrixTransform(r),v.y+=a,e.s=v.matrixTransform(r),e}var _=e,m=r,g=i,x=u(),y=null,v=null;t.show=function(){var e,r=g.apply(this,arguments),i=m.apply(this,arguments),n=_.apply(this,arguments),a=d3.select(x),o=0;for(a.html(r).style("display","block");o--;)a.classed(W[o],!1);return e=b.get(n).apply(this),a.classed(n,!0).style({top:e.top+i[0]+"px",left:e.left+i[1]+"px"}),t},t.hide=function(){return x.style.display="none",x.innerHTML="",t},t.attr=function(e,r){return arguments.length<2?d3.select(x).attr(e):(d3.select(x).attr(e,r),t)},t.style=function(e,r){return arguments.length<2?d3.select(x).style(e):(d3.select(x).style(e,r),t)},t.direction=function(e){return arguments.length?(_=null==e?e:d3.functor(e),t):_},t.offset=function(e){return arguments.length?(m=null==e?e:d3.functor(e),t):m},t.html=function(e){return arguments.length?(g=null==e?e:d3.functor(e),t):g};var b=d3.map({n:n,s:a,e:o,w:s,nw:h,ne:l,sw:p,se:c}),W=b.keys();return t};